---
layout:     post
title:      OpenCL加速计算
subtitle:   网格上的ising模型
date:       2024-02-27
author:     CLQ
header-img: img/nothing-in-here.jpg
catalog:    true
tags:
    - 高性能计算
    - OpenCL
    - 计算机
    - 代码开发
---

# 什么是OpenCL?

OpenCL是一组公开的代码API,用于规范异构计算。在这里我们指GPU并行计算。


参考：
[OpenCL 2.0 异构计算 [第三版] （Heterogeneous Computing with OpenCL 2.0）](https://www.bookstack.cn/read/Heterogeneous-Computing-with-OpenCL-2.0/README.md)

# 如何实现异构计算？

以我浅薄的理解：一般计算需要一下几个要素，代码，内存，计算核心，异构计算需要用一套代码，在不同类型内存，不同计算核心上运行，因此对代码计算核心和内存的抽象是必要的。

我们考虑如下几个问题：

1. 如何描述不同的内存
2. 如何描述不同的计算核心
3. 如何描述内存之间的相互作用
4. 如何描述计算核心之间的相互作用
5. 如何描述内存与计算核心之间的相互作用

## 如何描述不同的内存

clCreateBuffer可开辟OpenCL中特有的连续数组内存

```c
clCreateBuffer(
  cl_context context,
  cl_mem_flags flags,
  size_t size,
  void *host_ptr,
  cl_int *errcode_ret)
```

存在一个用于管理开辟的内存的集合，即上下文(context), 开辟的内存有可设置的读写属性，内存实际位置属性，有可设置的初始内容属性

可选的读写属性：CL_MEM_READ_ONLY，CL_MEM_WRITE_ONLY，CL_MEM_READ_WRITE

可选的实际位置属性：(CL_MEM_USE_HOST_PTR)：要求使用主机内存，(CL_MEM_COPY_HOST_PTR，CL_MEM_ALLOC_HOST_PTR)：不要求使用主机内存,

当然，还有主机上的一般内存，不由OpenCL规定

此外还有些核代码中的关键词用于声明内存类型：__constant，__global，__local

## 如何描述不同的计算核心

OpenCL计算核心可分为主机(host)，设备(device),其中设备还可以分为多个不同的工作核心，每个设备中的工作核心有唯一表示get_global_id(0),只能通过这一表示区别不同核心？

每个核心上可以并行执行核（kernel）代码

## 如何描述内存之间的相互作用

clEnqueueWriteBuffer，clEnqueueReadBuffer用于实现数据的转移，如从OpenCL管理的内存与一般主机上内存之间的数据交换。

```c
cl_int
clEnqueueWriteBuffer(
  cl_command_queue command_queue,
  cl_mem buffer,//OpenCL内存
  cl_bool blocking_write,//同步与异步数据传输
  size_t offset,
  size_t cb,
  const void *ptr,//host内存
  cl_uint num_events_in_wait_list,
  const cl_event *event_wait_list,
  cl_event *event)
```

## 如何描述计算核心之间的相互作用

主机计算核心与设备计算核心之间存在通信，主要是主机下达命令，设备接受，返回结果，附带一些参数的传递，参数的传递依靠上下文。

这种通信抽象为命令队列，

```c
cl_command_queue
clCreateCommandQueueWithProperties(
  cl_context context,
  cl_device_id device,
  cl_command_queue_properties peoperties,
  cl_int *errcode_ret)
```

可通过clEnqueueReadBuffer，clEnqueueNDRangeKernel在队列中插入命令


## 如何描述内存与计算核心之间的相互作用

核代码通过关键字，__constant，__global，__local，创建或者读取写入相应内存，这些不同关键字标识的内存有不同的限制，如访问速度，最大内存大小，能否在不同核心之间共享



